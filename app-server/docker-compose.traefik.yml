services:
  # ============================================
  # Traefik - Reverse Proxy com SSL Automático
  # ============================================
  traefik:
    image: traefik:v2.11
    container_name: eopix-traefik
    restart: unless-stopped
    command:
      # API e Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=true"  # Em produção, configure autenticação!
      
      # Providers
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=eopix-network"
      
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      
      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      
      # Let's Encrypt
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=admin@eopix.me"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge.entrypoint=web"
      
      # Logs
      - "--accesslog=true"
      - "--log.level=INFO"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Dashboard (proteger em produção!)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./letsencrypt:/letsencrypt
      - traefik-logs:/var/log/traefik
    networks:
      - eopix-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"
      # Dashboard (proteger com autenticação em produção!)
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN:-api-prod.eopix.me}`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dashboard.service=api@internal"

  # ============================================
  # Backend 1
  # ============================================
  backend1:
    image: ${BACKEND_IMAGE:-mateuus27/eopix-backend:latest}
    container_name: eopix-backend-1
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - PORT=4000
    networks:
      - eopix-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend1.rule=Host(`${DOMAIN:-api-prod.eopix.me}`)"
      - "traefik.http.routers.backend1.entrypoints=websecure"
      - "traefik.http.routers.backend1.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend1.loadbalancer.server.port=4000"
      - "traefik.http.routers.backend1.service=backend1"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Backend 2
  # ============================================
  backend2:
    image: ${BACKEND_IMAGE:-mateuus27/eopix-backend:latest}
    container_name: eopix-backend-2
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - PORT=4000
    networks:
      - eopix-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend2.rule=Host(`${DOMAIN:-api-prod.eopix.me}`)"
      - "traefik.http.routers.backend2.entrypoints=websecure"
      - "traefik.http.routers.backend2.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend2.loadbalancer.server.port=4000"
      - "traefik.http.routers.backend2.service=backend2"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Backend 3
  # ============================================
  backend3:
    image: ${BACKEND_IMAGE:-mateuus27/eopix-backend:latest}
    container_name: eopix-backend-3
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - PORT=4000
    networks:
      - eopix-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend3.rule=Host(`${DOMAIN:-api-prod.eopix.me}`)"
      - "traefik.http.routers.backend3.entrypoints=websecure"
      - "traefik.http.routers.backend3.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend3.loadbalancer.server.port=4000"
      - "traefik.http.routers.backend3.service=backend3"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  eopix-network:
    driver: bridge

volumes:
  traefik-logs:
  letsencrypt:
